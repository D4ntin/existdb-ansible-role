#!/bin/sh
### BEGIN INIT INFO
# Provides: eXist-db
# Required-Start:
# Required-Stop:
# Default-Start:  2 3 4 5
# Default-Stop: 0 1 6
# Short-Description: {{ exist_instname }}
# Description: eXist-db Database Server (instance {{ exist_instname }})
### END INIT INFO

EXIST_DIR={{ exist_path }}

# eXist-db standard Java options
EXIST_DEFAULT_OPTS="\
  -Xms128m \
  -Dfile.encoding=UTF-8 \
  -Dlog4j.configurationFile=${EXIST_DIR}/etc/log4j2.xml \
  -Dexist.home=${EXIST_DIR} \
  -Dexist.configurationFile=${EXIST_DIR}/etc/conf.xml \
  -Djetty.home=${EXIST_DIR} \
  -Dexist.jetty.config=${EXIST_DIR}/etc/jetty/standard.enabled-jetty-configs \
"

# custom options
EXIST_JAVA_OPTFILE=${EXIST_DIR}/etc/exist.java.options
if [ -f "${EXIST_JAVA_OPTFILE}" -a -r "${EXIST_JAVA_OPTFILE}" ]; then
    EXIST_JAVA_OPTS=`perl -ne 'next if /^\s*#/; print' <${EXIST_JAVA_OPTFILE}`
fi

# application booter options
REPO=${EXIST_DIR}/lib
CLASSPATH="${EXIST_DIR}/etc:${REPO}/appassembler-booter-2.1.0.jar:${REPO}/appassembler-model-2.1.0.jar:${REPO}/plexus-utils-3.2.0.jar:${REPO}/stax-api-1.0.1.jar:${REPO}/stax-1.1.1-dev.jar"
EXIST_BOOTER_OPTS="\
  -classpath $CLASSPATH \
  -Dapp.name=startup \
  -Dapp.pid=$$ \
  -Dapp.repo=${REPO} \
  -Dapp.home=${EXIST_DIR} \
  -Dbasedir=${EXIST_DIR} \
  org.codehaus.mojo.appassembler.booter.AppassemblerBooter"

FULLCMD="{{ ansible_env.JAVA_HOME }}/bin/java ${EXIST_DEFAULT_OPTS} ${EXIST_JAVA_OPTS} ${EXIST_BOOTER_OPTS}"


status() {
    if pgrep -lf {{ exist_instname }}.start.jar; then
	echo running
	exit 0
    else
	echo stopped
	exit 1
    fi
}

stopit() {
    echo "Stopping eXist-db ..."
    echo ${FULLCMD} "$@"
    cd {{ exist_path }} && sudo -u {{ exist_instuser }} ${FULLCMD} "$@"
}

startit() {
    echo "Starting eXist-db ..."
    echo ${FULLCMD} "$@"
    cd {{ exist_path }} && sudo -u {{ exist_instuser }} ${FULLCMD} "$@"
}


case "$1" in
    'start')
        startit
        ;;

    'stop')
        stopit
        ;;

    'restart')
        stopit
        startit
        ;;


    'force-reload')
        stopit
        startit
        ;;

    'status')
        status
        ;;

    *)
        echo "Usage: $0 { start | stop | restart | status }"
        exit 1
        ;;
esac

exit $?
